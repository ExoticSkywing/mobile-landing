---
import { siteConfig } from "@config/site";
---

<aside id="neon-menu" class="fixed z-[9999] opacity-0 invisible pointer-events-none transition-all duration-200 ease-out blur-sm grayscale-[0.2]">
    <span class="shine shine-top"></span>
    <span class="shine shine-bottom"></span>
    <span class="glow glow-top"></span>
    <span class="glow glow-bottom"></span>
    <span class="glow glow-bright glow-top"></span>
    <span class="glow glow-bright glow-bottom"></span>

    <div class="inner flex flex-col gap-2 text-sm">
        
        <!-- Header -->
        <header class="px-2 py-1 text-xs font-light text-gray-400 uppercase tracking-widest opacity-60">
            System Control
        </header>

        <!-- Section 1: Navigation -->
        <section>
            <ul class="flex flex-col gap-2">
                <li tabindex="0" class="menu-item group" data-action="reload">
                    <svg class="w-5 h-5 opacity-60 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span>Reload System</span>
                </li>
                <li tabindex="0" class="menu-item group" data-action="official">
                    <svg class="w-5 h-5 opacity-60 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>Official Site</span>
                </li>
            </ul>
        </section>

        <hr class="border-t border-white/10 opacity-50 my-1" />

        <!-- Section 2: Actions -->
        <section>
            <ul class="flex flex-col gap-2">
                <li tabindex="0" class="menu-item group" data-action="theme">
                    <svg class="w-5 h-5 opacity-60 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                    <span>Toggle Theme</span>
                </li>
                <li tabindex="0" class="menu-item group" data-action="speedtest">
                    <svg class="w-5 h-5 opacity-60 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>Speed Test</span>
                </li>
            </ul>
        </section>
    </div>
</aside>

<script>
    import { siteConfig } from "@config/site";

    const menu = document.getElementById('neon-menu');
    const items = menu?.querySelectorAll('.menu-item');

    let cleanTimer: NodeJS.Timeout;

    // Open Menu
    document.addEventListener('contextmenu', (e) => {
        // Ignroe if clicking on inputs
        if ((e.target as HTMLElement).tagName === 'INPUT' || (e.target as HTMLElement).tagName === 'TEXTAREA') return;

        e.preventDefault();
        
        if (!menu) return;

        const menuBox = menu.getBoundingClientRect();
        const winWidth = window.innerWidth;
        const winHeight = window.innerHeight;
        
        // Calculate Position (keep onscreen)
        let x = e.clientX;
        let y = e.clientY;

        if (x + menuBox.width > winWidth) x = winWidth - menuBox.width - 20;
        if (y + menuBox.height > winHeight) y = winHeight - menuBox.height - 20;

        menu.style.left = `${x}px`;
        menu.style.top = `${y}px`;
        menu.classList.add('open');
        
        clearTimeout(cleanTimer);
    });

    // Close Menu
    document.addEventListener('pointerdown', (e) => {
        if (!menu) return;
        const target = e.target as HTMLElement;
        
        if (!menu.contains(target)) {
            menu.classList.remove('open');
            // Reset selection style delay
            cleanTimer = setTimeout(() => {
                items?.forEach(el => el.classList.remove('selected'));
            }, 200);
        }
    });

    // Item Actions
    items?.forEach(item => {
        item.addEventListener('click', () => {
             // Visual feedback
             item.classList.add('selected');
             
             const action = item.getAttribute('data-action');
             
             setTimeout(() => {
                 menu?.classList.remove('open');
                 handleAction(action);
                 item.classList.remove('selected');
             }, 150);
        });
    });

    function handleAction(action: string | null) {
        if (!action) return;
        
        switch(action) {
            case 'reload':
                window.location.reload();
                break;
            case 'official':
                window.open(siteConfig.officialSite || '#', '_blank');
                break;
            case 'theme':
                // Toggle via data-theme or class
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                break;
            case 'speedtest':
                document.getElementById('device-toggle')?.scrollIntoView({ behavior: 'smooth' });
                break;
        }
    }
</script>

<style>
    /* 
     * Ported & Adapted from Neon Glass Context Menu 
     * Original Hue1: 255 (Violet) -> We keep this
     * Original Hue2: 222 (Blue) -> We shift to Cyan (190) for our brand
    */
    
    :root {
        --hue1: 260; /* Violet */
        --hue2: 190; /* Cyan */
        --border: 1px;
        --radius: 16px;
        --ease: cubic-bezier(0.5, 1, 0.89, 1);
    }

    #neon-menu {
        --border-color: hsl(var(--hue2), 12%, 20%);
        min-width: 200px;
        padding: 0.75em;
        border-radius: var(--radius);
        border: var(--border) solid var(--border-color);
        background: 
            linear-gradient(235deg, hsl(var(--hue1) 50% 10% / 0.8), hsl(var(--hue1) 50% 10% / 0) 33%), 
            linear-gradient(45deg, hsl(var(--hue2) 50% 10% / 0.8), hsl(var(--hue2) 50% 10% / 0) 33%), 
            linear-gradient(hsl(220deg 25% 4.8% / 0.85)); /* Darker base */
        backdrop-filter: blur(20px);
        box-shadow: hsl(var(--hue2) 50% 2%) 0px 10px 16px -8px, hsl(var(--hue2) 50% 4%) 0px 20px 36px -14px;
        color: #93c5fd;
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* Open State */
    #neon-menu.open {
        visibility: visible;
        opacity: 1;
        pointer-events: auto;
        filter: blur(0px) grayscale(0);
        transform: scale(1);
    }
    
    /* Animation Triggers */
    #neon-menu.open .shine { animation: glow 1.5s var(--ease) both; }
    #neon-menu.open .glow { animation: glow 1s var(--ease) both 0.2s; }

    /* Shine Elements (The bright edges) */
    .shine {
        position: absolute;
        inset: -1px;
        border-radius: inherit;
        pointer-events: none;
        z-index: 1;
        mask: linear-gradient(transparent), linear-gradient(black);
        mask-composite: subtract;
        mask-clip: padding-box, border-box;
        border: 1px solid transparent;
        background: conic-gradient(from var(--conic, -45deg) at center, transparent 15%, hsl(var(--hue1), 80%, 70%) 20%, transparent 40%) border-box;
        opacity: 0;
    }
    .shine-bottom { --conic: 135deg; background: conic-gradient(from var(--conic, -45deg) at center, transparent 15%, hsl(var(--hue2), 80%, 70%) 20%, transparent 40%) border-box; }

    /* Glow Elements (The bleed) */
    .glow {
        position: absolute;
        inset: -20px;
        border-radius: 40px;
        background: conic-gradient(from var(--conic, -45deg) at center, transparent 10%, hsl(var(--hue1), 90%, 60%) 20%, transparent 50%);
        filter: blur(12px) opacity(0.5);
        opacity: 0;
        z-index: -1;
        pointer-events: none;
    }
    .glow-bottom { --conic: 135deg; --hue1: var(--hue2); }

    /* Menu Items */
    .menu-item {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        background: transparent;
        outline: none;
    }

    /* Hover/Focus State */
    .menu-item:hover, .menu-item:focus, .menu-item.selected {
        background: linear-gradient(90deg, rgba(139, 92, 246, 0.15), rgba(6, 182, 212, 0.15));
        border-color: rgba(139, 92, 246, 0.3);
        box-shadow: 0 0 10px rgba(139, 92, 246, 0.1);
        color: white;
    }
    
    .menu-item.selected {
        animation: flash 0.4s ease-out;
    }

    @keyframes glow {
        0% { opacity: 0; }
        20% { opacity: 1; }
        100% { opacity: 0.4; } /* Linger */
    }
    
    @keyframes flash {
        0%, 100% { opacity: 1; background-color: rgba(255,255,255,0.1); }
        50% { opacity: 0.8; background-color: rgba(255,255,255,0.3); }
    }
</style>
